<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Firmware Interface - Ctrl-P</title> <!-- Add FontAwesome to the site--> <!-- <script src="https://kit.fontawesome.com/a25c836932.js" crossorigin="anonymous"></script> --> <script type="text/javascript"> (function() { var css = document.createElement('link'); css.href = 'https://use.fontawesome.com/releases/v5.15.1/css/all.css'; css.rel = 'stylesheet'; css.type = 'text/css'; document.getElementsByTagName('head')[0].appendChild(css); })(); </script> <!-- <script defer src="/v2.1/assets/css/fontawesome-free-5.15.1-web/js/all.js" rel="stylesheet"></script> --> <!-- Add JQuery to the site--> <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script> <link rel="shortcut icon" href="/v2.1/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/v2.1/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-98839874-5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-98839874-5'); </script> <script type="text/javascript" src="/v2.1/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/v2.1/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Firmware Interface | Ctrl-P</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Firmware Interface" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A custom pneumatic control system featuring smooth control of pressure at a high bandwidth." /> <meta property="og:description" content="A custom pneumatic control system featuring smooth control of pressure at a high bandwidth." /> <link rel="canonical" href="/v2.1/firmware/firmware_interface" /> <meta property="og:url" content="/v2.1/firmware/firmware_interface" /> <meta property="og:site_name" content="Ctrl-P" /> <script type="application/ld+json"> {"description":"A custom pneumatic control system featuring smooth control of pressure at a high bandwidth.","url":"/v2.1/firmware/firmware_interface","@type":"WebPage","headline":"Firmware Interface","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/v2.1/assets/img/soft_hand.svg"}},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/v2.1/" class="site-title lh-tight"> <div class="site-logo"></div> <div class="site-title-text">Ctrl-P</div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/v2.1/" class="nav-list-link"> <div class=nav-icons><i class="fas fa-home"></i></div> Home </a></li><li class="nav-list-item"><a href="/v2.1/hardware" class="nav-list-link"> <div class=nav-icons><i class="fas fa-tools"></i></div> Hardware </a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/v2.1/firmware" class="nav-list-link"> <div class=nav-icons><i class="fas fa-microchip"></i></div> Firmware </a><ul class="nav-list "><li class="nav-list-item nav-bullets active"><a href="/v2.1/firmware/firmware_interface" class="nav-list-link active">Firmware Interface</a></li><li class="nav-list-item nav-bullets"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/v2.1/firmware/firmware_commands" class="nav-list-link">Firmware Commands</a><ul class="nav-list"><li class="nav-list-item nav-bullets"> <a href="/v2.1/firmware/firmware_commands/fw_cmd_v2" class="nav-list-link">Command Spec (v2.0)</a> </li><li class="nav-list-item nav-bullets"> <a href="/v2.1/firmware/firmware_commands/fw_cmd_v1" class="nav-list-link">Command Spec (v1.0)</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/v2.1/top-level" class="nav-list-link"> <div class=nav-icons><i class="fas fa-laptop-code"></i></div> Python Interface </a><ul class="nav-list "><li class="nav-list-item nav-bullets"><a href="/v2.1/top-level/setup" class="nav-list-link">Hardware Setup</a></li><li class="nav-list-item nav-bullets"><a href="/v2.1/top-level/tutorial" class="nav-list-link">Tutorial</a></li><li class="nav-list-item nav-bullets"><a href="/v2.1/top-level/plotting-data" class="nav-list-link">Plotting Data</a></li><li class="nav-list-item nav-bullets"><a href="/v2.1/top-level/python-tips" class="nav-list-link">Python Tips</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/v2.1/ros-driver" class="nav-list-link"> <div class=nav-icons><i class="fas fa-robot"></i></div> ROS Driver </a><ul class="nav-list "><li class="nav-list-item nav-bullets"><a href="/v2.1/ros-driver/tutorial" class="nav-list-link">Tutorial</a></li></ul></li><li class="nav-list-item"><a href="/v2.1/gallery" class="nav-list-link"> <div class=nav-icons><i class="fas fa-images"></i></div> Photo Gallery </a></li><li class="nav-list-item"><a href="/v2.1/todo" class="nav-list-link"> <div class=nav-icons><i class="fas fa-tasks"></i></div> TODO </a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Ctrl-P" aria-label="Search Ctrl-P" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/cbteeple/pressure_controller" class="site-button" target="_blank" rel="noopener noreferrer" > Firmware <i class="aux-icon fab fa-github"></i> </a> </li> <li class="aux-nav-list-item"> <a href="//github.com/cbteeple/pressure_control_interface" class="site-button" target="_blank" rel="noopener noreferrer" > Python Interface <i class="aux-icon fab fa-github"></i> </a> </li> <li class="aux-nav-list-item"> <a href="//github.com/cbteeple/pressure_control_cbt" class="site-button" target="_blank" rel="noopener noreferrer" > ROS Driver <i class="aux-icon fab fa-github"></i> </a> </li> <li> <div class="version-selector"> <div>Version:</div> <div> <select onchange="switch_version(this)" name="version" id="version_selecter"> <option value="/latest/firmware/firmware_interface">latest</option> <option selected value="/v2.1/firmware/firmware_interface">v2.1</option> <option value="/v2.0/firmware/firmware_interface">v2.0</option> <option value="/v1.0/firmware/firmware_interface">v1.0</option> </select> </div> </div> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/v2.1/firmware">Firmware</a></li> <li class="breadcrumb-nav-list-item"><span>Firmware Interface</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="firmware-interface"> <a href="#firmware-interface" class="anchor-heading" aria-labelledby="firmware-interface"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Firmware Interface </h1> <ol id="markdown-toc"> <li><a href="#safety-features" id="markdown-toc-safety-features">Safety Features</a></li> <li><a href="#basic-operation" id="markdown-toc-basic-operation">Basic Operation</a></li> <li><a href="#configuring-the-firmware" id="markdown-toc-configuring-the-firmware">Configuring the Firmware</a></li> <li><a href="#configuring-the-pid-gains" id="markdown-toc-configuring-the-pid-gains">Configuring the PID gains</a></li> </ol><hr /> <h2 id="safety-features"> <a href="#safety-features" class="anchor-heading" aria-labelledby="safety-features"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Safety Features </h2> <h3 id="pressure-runaway-watchdog"> <a href="#pressure-runaway-watchdog" class="anchor-heading" aria-labelledby="pressure-runaway-watchdog"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Pressure Runaway Watchdog </h3> <p>Looks at the pressure in all of the currently active channels, and immediately vents all channels if any channel goes above a configurable maximum. Things can get damaged if the pressure were to accidentally reach too high, so this always runs. To set the maximum pressures:</p> <ol> <li>“<strong>MAXP;[some value]</strong>” - Set the pressure where the watchdog should trigger.</li> </ol> <h3 id="setpoint-guarding"> <a href="#setpoint-guarding" class="anchor-heading" aria-labelledby="setpoint-guarding"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setpoint Guarding </h3> <p>When in pressure control mode (<em>mode 1</em>), the setpoint is only allowed between some upper and lower bound</p> <ol> <li>“<strong>MAXP;[some value]</strong>” - Maximum pressure, same as the watchdog pressure. We don’t allow pressure to be commanded higher than this</li> <li>“<strong>MINP;[some value]</strong>” - Minimum pressure. Don’t allow pressures to be set smaller than this.</li> </ol> <h2 id="basic-operation"> <a href="#basic-operation" class="anchor-heading" aria-labelledby="basic-operation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Operation </h2> <p>If someone has configured and flashed this firmware to an arduino for you to use, this is where you should read.</p> <h3 id="system-startup"> <a href="#system-startup" class="anchor-heading" aria-labelledby="system-startup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> System startup </h3> <p>Upon powering on the system, you should send the following commands to resume from where you left off last time:</p> <ol> <li>“<strong>LOAD</strong>”. This loads the PID controller settings that were configured for you. (This is automatically executed on startup)</li> <li>“<strong>SET;0;0</strong>”. This ensures all channels are set to 0psi immediately before starting.</li> <li>“<strong>MODE;3</strong>”. This ensures you are in “pressure control +ramp” mode</li> </ol> <h3 id="decide-what-you-want-to-see"> <a href="#decide-what-you-want-to-see" class="anchor-heading" aria-labelledby="decide-what-you-want-to-see"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Decide what you want to see </h3> <p>Now you can choose whether you want to see the live pressure output or not</p> <ol> <li>“<strong>ON</strong>”. This turns on the live pressure output</li> <li>“<strong>OFF</strong>”. This turns off the live pressure output</li> <li>“<strong>TIME; 100</strong>” This will set the output time to 100 ms (10 HZ). Feel free ro set this however fast you want it.</li> </ol> <h3 id="set-pressures-and-go"> <a href="#set-pressures-and-go" class="anchor-heading" aria-labelledby="set-pressures-and-go"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Set pressures and go! </h3> <p>Now you can set pressures and the controller will take you there. It’s as simple as that!</p> <ol> <li>“<strong>SET;#1;#2</strong>”. This ramps to the desired pressure (<strong>#2</strong>) for all channels in <strong>#1</strong> seconds.</li> <li>“<strong>SET;#1;#2;#3;…;#N+1</strong>”. This sets the desired pressure separately for each channel (assuming you have N channels), and ramps to that pressure over <strong>#1</strong> seconds..</li> </ol> <h3 id="saving-incoming-data"> <a href="#saving-incoming-data" class="anchor-heading" aria-labelledby="saving-incoming-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Saving incoming data </h3> <p>If you want to save the measured pressure, you need to intercept the incoming serial stream. In addition, you need to filter out all of the command echos that happen every time you send a command (like a new setpoint).</p> <h4 id="the-simple-way---copy--paste"> <a href="#the-simple-way---copy--paste" class="anchor-heading" aria-labelledby="the-simple-way---copy--paste"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The simple way - copy &amp; paste </h4> <p>The simple (but cumbersome) way to do this is just to use a serial material (like Arduino’s serial monitor baked into their IDE).</p> <ol> <li>Turn on the data stream with the “<strong>ON</strong>” command</li> <li>Do your tests</li> <li>Turn the stream off with the “<strong>OFF</strong>” command.</li> <li>Copy and paste all of the incoming data into a spreadsheet or text file to save and use later.</li> <li><em>Don’t forget to delete all of the rows with commands in them</em> (you’ll have to hunt for them).</li> </ol> <h4 id="the-slick-way---directly-intercept-the-incoming-stream"> <a href="#the-slick-way---directly-intercept-the-incoming-stream" class="anchor-heading" aria-labelledby="the-slick-way---directly-intercept-the-incoming-stream"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The slick way - directly intercept the incoming stream </h4> <p>If you can set up a direct interface to the incoming serial line with MATLAB or python, this is much nicer. Now you can automatically save all the data, and you can filter out command echos. <strong>Command echos ALWAYS start with an underscore (“_”) character.</strong> This makes it easy to set up a quick if-statement to check if the first character in the incoming line of data is an underscore.</p> <h2 id="configuring-the-firmware"> <a href="#configuring-the-firmware" class="anchor-heading" aria-labelledby="configuring-the-firmware"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring the Firmware </h2> <p>This is where to read if you are setting up this system to be used.</p> <h3 id="we-use-configuration-files-in-the-config-folder-"> <a href="#we-use-configuration-files-in-the-config-folder-" class="anchor-heading" aria-labelledby="we-use-configuration-files-in-the-config-folder-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> We use configuration files in the “config” folder : </h3> <p>Things to change depending on your hardware:</p> <ol> <li>Number of channels (<code class="language-plaintext highlighter-rouge">MAX_NUM_CHANNELS</code>)</li> <li>Sensor type (set <code class="language-plaintext highlighter-rouge">SENSOR_ANALOG</code> and <code class="language-plaintext highlighter-rouge">SENSOR_I2C</code> true or false depending on the type you are using.)</li> <li>Control type (set the types true or false depending on which one you want to use).</li> <li>Valve pins (set the pairs of pins to use as “channels”)</li> <li>i2c addresses (if using i2c sensors)</li> <li>Default controller settings</li> </ol> <p>NOTE: you might also need to change the number of channels in the “traj” class, since I haven’t found a nice way to make that depend on the config file yet.</p> <h2 id="configuring-the-pid-gains"> <a href="#configuring-the-pid-gains" class="anchor-heading" aria-labelledby="configuring-the-pid-gains"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring the PID gains </h2> <p>You can pretty much just use the <a href="https://en.wikipedia.org/wiki/PID_controller#Ziegler%E2%80%93Nichols_method" target="_blank">Ziegler-Nichols</a> method verbatim.</p> <hr> <div class="section-nav"> <a href="/v2.1/firmware" id="prev-section" class="btn btn-outline"> <i class="fas fa-chevron-left"></i> <div class="section-nav-content"> <div class=section-nav-crumb> <i class="fas fa-microchip"></i> </div> Firmware </div> </a> <a href="/v2.1/firmware/firmware_commands" id="next-section" class="btn btn-outline"> <div class="section-nav-content"> <div class=section-nav-crumb> Firmware / </div> Firmware Commands </div> <i class="fas fa-chevron-right"></i> </a> </div> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">&copy; 2019-2021 by <a target="_blank" href="http://cbteeple.com">Clark Teeple</a></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> <!--Build the modal overlay for nice picture display--> <div class="wrapper" style="position: relative"> <div id="modal-overlay"> <!-- <a href="javascript:void(0);" id="modal-prev" class="modal-main-nav modal-btn" title="Previous (Left Arrow Key)"> <i class="fas fa-chevron-circle-left"></i> </a> --> <div id="modal" title="Click anywhere to close (Esc)"> <div id="modal-content"> <a href="#" id="modal-img-a" class="img-overlay-container" title="Scroll to Image"> <img id="modal-img"/> </a> <div id="modal-description"/></div> </div> </div> <a href="javascript:void(0);" id="modal-close" class="modal-btn" title="Close (Esc)"> <i class="fas fa-times-circle"></i> </a> <div class="modal-small-nav-container"> <a href="javascript:void(0);" id="modal-prev-aux" class="modal-small-nav modal-btn" title="Previous (Left Arrow Key)"> <i class="fas fa-chevron-circle-left"></i> </a> <a href="javascript:void(0);" id="modal-next-aux" class="modal-small-nav modal-btn" title="Next (Right Arrow Key)"> <i class="fas fa-chevron-circle-right"></i> </a> </div> </div> </div> <script src="/v2.1/assets/js/img-modal.js"></script> <script src="/v2.1/assets/js/ext-links.js"></script> <script src="/v2.1/assets/js/switch-version.js"></script> </body> </html>
