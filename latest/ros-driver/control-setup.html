<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Control Setup - Ctrl-P</title> <!-- Add FontAwesome to the site--> <!-- <script src="https://kit.fontawesome.com/a25c836932.js" crossorigin="anonymous"></script> --> <script type="text/javascript"> (function() { var css = document.createElement('link'); css.href = 'https://use.fontawesome.com/releases/v5.15.1/css/all.css'; css.rel = 'stylesheet'; css.type = 'text/css'; document.getElementsByTagName('head')[0].appendChild(css); })(); </script> <!-- <script defer src="/latest/assets/css/fontawesome-free-5.15.1-web/js/all.js" rel="stylesheet"></script> --> <!-- Add JQuery to the site--> <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script> <link rel="shortcut icon" href="/latest/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/latest/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-98839874-5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-98839874-5'); </script> <script type="text/javascript" src="/latest/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/latest/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Control Setup | Ctrl-P</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Control Setup" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A custom pneumatic control system featuring smooth control of pressure at a high bandwidth." /> <meta property="og:description" content="A custom pneumatic control system featuring smooth control of pressure at a high bandwidth." /> <link rel="canonical" href="/latest/ros-driver/control-setup" /> <meta property="og:url" content="/latest/ros-driver/control-setup" /> <meta property="og:site_name" content="Ctrl-P" /> <script type="application/ld+json"> {"description":"A custom pneumatic control system featuring smooth control of pressure at a high bandwidth.","url":"/latest/ros-driver/control-setup","@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/latest/assets/img/soft_hand.svg"}},"headline":"Control Setup","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/latest/" class="site-title lh-tight"> <div class="site-logo"></div> <div class="site-title-text">Ctrl-P</div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/latest/" class="nav-list-link"> <div class=nav-icons><i class="fas fa-home"></i></div> Home </a></li><li class="nav-list-item"><a href="/latest/hardware" class="nav-list-link"> <div class=nav-icons><i class="fas fa-tools"></i></div> Hardware </a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/latest/firmware" class="nav-list-link"> <div class=nav-icons><i class="fas fa-microchip"></i></div> Firmware </a><ul class="nav-list "><li class="nav-list-item nav-bullets"><a href="/latest/firmware/firmware_interface" class="nav-list-link">Firmware Interface</a></li><li class="nav-list-item nav-bullets"><a href="/latest/firmware/firmware_commands" class="nav-list-link">Firmware Commands</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/latest/top-level" class="nav-list-link"> <div class=nav-icons><i class="fas fa-laptop-code"></i></div> Python Interface </a><ul class="nav-list "><li class="nav-list-item nav-bullets"><a href="/latest/top-level/setup" class="nav-list-link">Hardware Setup</a></li><li class="nav-list-item nav-bullets"><a href="/latest/top-level/tutorial" class="nav-list-link">Tutorial</a></li><li class="nav-list-item nav-bullets"><a href="/latest/top-level/python-tips" class="nav-list-link">Python Tips</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/latest/ros-driver" class="nav-list-link"> <div class=nav-icons><i class="fas fa-robot"></i></div> ROS Driver </a><ul class="nav-list "><li class="nav-list-item nav-bullets"><a href="/latest/ros-driver/ros-basics" class="nav-list-link">ROS Basics</a></li><li class="nav-list-item nav-bullets"><a href="/latest/ros-driver/setup" class="nav-list-link">Hardware Setup</a></li><li class="nav-list-item nav-bullets active"><a href="/latest/ros-driver/control-setup" class="nav-list-link active">Control Setup</a></li><li class="nav-list-item nav-bullets"><a href="/latest/ros-driver/tutorial" class="nav-list-link">Basic Tutorial</a></li><li class="nav-list-item nav-bullets"><a href="/latest/ros-driver/tutorial-realtime" class="nav-list-link">Realtime Control</a></li></ul></li><li class="nav-list-item"><a href="/latest/gallery" class="nav-list-link"> <div class=nav-icons><i class="fas fa-images"></i></div> Photo Gallery </a></li><li class="nav-list-item"><a href="/latest/todo" class="nav-list-link"> <div class=nav-icons><i class="fas fa-tasks"></i></div> TODO </a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Ctrl-P" aria-label="Search Ctrl-P" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/cbteeple/pressure_controller" class="site-button" target="_blank" rel="noopener noreferrer" > Firmware <i class="aux-icon fab fa-github"></i> </a> </li> <li class="aux-nav-list-item"> <a href="//github.com/cbteeple/pressure_control_interface" class="site-button" target="_blank" rel="noopener noreferrer" > Python Interface <i class="aux-icon fab fa-github"></i> </a> </li> <li class="aux-nav-list-item"> <a href="//github.com/cbteeple/pressure_control_cbt" class="site-button" target="_blank" rel="noopener noreferrer" > ROS Driver <i class="aux-icon fab fa-github"></i> </a> </li> <li> <div class="version-selector"> <div>Version:</div> <div> <select onchange="switch_version(this)" name="version" id="version_selecter"> <option selected value="/latest/ros-driver/control-setup">latest</option> <option value="/v2.0/ros-driver/control-setup">v2.0</option> <option value="/v1.0/ros-driver/control-setup">v1.0</option> </select> </div> </div> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/latest/ros-driver">ROS Driver</a></li> <li class="breadcrumb-nav-list-item"><span>Control Setup</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="-control-setup"> <a href="#-control-setup" class="anchor-heading" aria-labelledby="-control-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <i class="fas fa-cog"></i> Control Setup </h1> <ol id="markdown-toc"> <li><a href="#build-a-controller-config-file" id="markdown-toc-build-a-controller-config-file">Build a controller config file</a></li> <li><a href="#tune-valve-pwm-offsets" id="markdown-toc-tune-valve-pwm-offsets">Tune valve PWM offsets</a></li> <li><a href="#tune-pid-gains" id="markdown-toc-tune-pid-gains">Tune PID gains</a></li> </ol><hr /> <h2 id="build-a-controller-config-file"> <a href="#build-a-controller-config-file" class="anchor-heading" aria-labelledby="build-a-controller-config-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build a controller config file </h2> <p>Set up all the control settings (like which channels are on, PID gains, etc.).</p> <ol> <li>Create a new control config file based on an existing one (must be located in the <code class="language-plaintext highlighter-rouge">config/control</code> folder of your package) <ul> <li>Configuration files are “<em>.yaml</em>” files with a few specific fields related to actual pressure control</li> </ul> </li> <li>Update relevant fields for your hardware setup</li> </ol> <h3 id="control-config-fields"> <a href="#control-config-fields" class="anchor-heading" aria-labelledby="control-config-fields"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Control config fields </h3> <ul> <li>Channel Settings <ul> <li><strong>num_channels</strong> (<code class="language-plaintext highlighter-rouge">int</code>) - Number of channels total (across all devices)</li> <li><strong>states</strong> (<code class="language-plaintext highlighter-rouge">list(bool)</code>) - The On/Off state of each channel. (Length of this list much match <em>num_channels</em>)</li> </ul> </li> <li><strong>data_loop_time</strong> (<code class="language-plaintext highlighter-rouge">int</code>) - The period (in ms) to send data back from the controllers. (min value is ~4ms)</li> <li>PID Settings <ul> <li><strong>all_equal</strong> (<code class="language-plaintext highlighter-rouge">bool</code>) - Decide whether the PID gains of all channels are set the othe same values</li> <li><strong>integrator_start</strong> (<code class="language-plaintext highlighter-rouge">float</code>) - The window around the setpoint in which integration is allowed. (This prevents integrator windup)</li> <li><strong>values</strong> (<code class="language-plaintext highlighter-rouge">list(float)</code>) - The actual P, I, and D values (in that order). <em>Set to a list of length 3 to give all channels the same gains. Set to a list of lists to specify gains on a per-channel basis (much include values for all channels if using this option).</em></li> </ul> </li> <li><strong>valve_offsets</strong> (<code class="language-plaintext highlighter-rouge">list(list(int))</code>) - PWM offset values for valves. <em>Set to a list, where each entry is a list of length 2 with the source and vent offsets for that particular channel.</em></li> <li><strong>max_pressure</strong> (<code class="language-plaintext highlighter-rouge">float</code>) - Maximum pressure (in psi) before software watchdog kicks in. <em>Set to a number to apply the same value to all channels. Set to a list to specify values on a per-channel basis (much include values for all channels).</em></li> <li><strong>min_pressure</strong> (<code class="language-plaintext highlighter-rouge">float</code>) - Minimum pressure (in psi). Setpoints are clipped to this value. <em>Set to a number to apply the same value to all channels. Set to a list to specify values on a per-channel basis (much include values for all channels).</em></li> <li><strong>transitions</strong> (<code class="language-plaintext highlighter-rouge">float</code>) - Default transition time (in sec) when sending single setpoints to the controller</li> <li><strong>echo</strong> (<code class="language-plaintext highlighter-rouge">bool</code>) - Turn debugging command echos on (usually this should be false)</li> </ul> <h2 id="tune-valve-pwm-offsets"> <a href="#tune-valve-pwm-offsets" class="anchor-heading" aria-labelledby="tune-valve-pwm-offsets"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tune valve PWM offsets </h2> <p>The PWM offsets allow us to do smooth control starting from the voltages at which the valves just barely crack open. This ensures we can actually control the flow rate smoothly. You will need to re-calibrate these every so often as the resistance and mechanical parts of the valves will slightly change over time.</p> <p><img src="/latest/assets/img/valve_offset_cal.png" alt="Plot of the &quot;setpoint_traj_demo&quot; trajectory" /></p> <ol> <li> <p>Bringup the pressure controller(s)</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> roscore &amp;
 roslaunch pressure_controller_ros bringupHID.launch  hw_profile:<span class="o">=[</span>HARDWARE CONFIG]  profile:<span class="o">=[</span>CONTROL_CONFIG]
</code></pre></div> </div> </li> <li> <p>Start up the valve calibration gui (in a new terminal)</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> rosrun pressure_controller_setup rqt_calibrate_valves.py 
</code></pre></div> </div> </li> <li>Listen to the valves, observe the resulting data, and update your config <ol> <li>If the valves hum for a short time before you see any actual air flow and there is low-frequency oscillations in pressure, <em>increase the PWM value</em> for that channel by ~2-3.</li> <li>If the valves click a lot and pressure oscillates rapidly while maintaining a steady pressure, <em>decrease the PWM value</em> for that channel by ~2-3.</li> <li>You may need to set the voltage offsets differently for the source and vent valve in each channel if (for example) a channel can provide pressure but has trouble venting.</li> </ol> </li> <li> <p>When you’re done, close the gui and your new valve offsets will print to the terminal (like this):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Final Valve Offsets:
 [[229, 229], [234, 244], [241, 234], [234, 234], [225, 225], [216, 213], [221, 220], [228, 228]]

 Copy these settings into 'valve_offsets' in your control config file
</code></pre></div> </div> </li> </ol> <p>Once you tune these values, you should be all set. They are related to properties of the actual valves, not the load you are driving, so you will only need to re-calibrate this avery so often throughout the year.</p> <p><strong>IMPORTANT: Remember to either:</strong></p> <ol> <li><strong>Copy these values into all of your config files</strong> OR</li> <li><strong>Remove the ‘valve_offsets’ parameter from your config files.</strong></li> </ol> <p>These valve offset settings are saved to the controller when you close the gui, so they will be recalled each time the controller is powered up unless you overwrite them by putting them in your config files.</p> <h2 id="tune-pid-gains"> <a href="#tune-pid-gains" class="anchor-heading" aria-labelledby="tune-pid-gains"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tune PID gains </h2> <p>Since a PID controller is inherently model-free, you will need to tune the gains for each new load (pneumatic device) you place on each channel. The following process seems to work reasonably well:</p> <ol> <li>Bringup the pressure controller(s) <ul> <li><code class="language-plaintext highlighter-rouge">roslaunch pressure_controller_ros bringup_only.launch hw_profile:=[HARDWARE CONFIG]</code></li> </ul> </li> <li>Initialize your control config <ol> <li>Set <code class="language-plaintext highlighter-rouge">I = 0</code> and <code class="language-plaintext highlighter-rouge">D = 0 </code> for all channels to start.</li> <li>Set <code class="language-plaintext highlighter-rouge">P</code> to a value you think is too low (0.1 is a good place to start).</li> <li>Save, then send the config to the controller: <code class="language-plaintext highlighter-rouge">roslaunch pressure_controller_ros config.launch profile:=[CONTROL CONFIG]</code></li> </ol> </li> <li>Apply a small step change in pressure to all channels <ul> <li><code class="language-plaintext highlighter-rouge">roslaunch pressure_controller_ros set_setpoint.launch</code></li> </ul> </li> <li>Observe the resulting data and update your config <ol> <li>If the controller oscillates, set <code class="language-plaintext highlighter-rouge">P</code> lower and resend the config until it stops.</li> <li>If the controller does not oscillate, set <code class="language-plaintext highlighter-rouge">P</code> higher and resend the config until it starts oscillating, then back off slowly until it stops.</li> </ol> </li> <li>Add integral gain <ol> <li>Set <code class="language-plaintext highlighter-rouge">I</code> to a value 1/10th of the cUrrent value of <code class="language-plaintext highlighter-rouge">P</code> for each channel and test.</li> <li>If the controller oscillates, decrease <code class="language-plaintext highlighter-rouge">I</code></li> <li>If the controller takes a while to reach the setpoint, increase <code class="language-plaintext highlighter-rouge">I</code></li> </ol> </li> <li>Add derivative gain (optional) <ol> <li>In testing, it usually seems like a P-I controller works very well to achieve fast, reliable pressure control. If you do see lots of sharp motions in the control, you can add a small amount of <code class="language-plaintext highlighter-rouge">D</code> to smooth this off.</li> </ol> </li> </ol> <p>Based on some basic testing, we found that the values you come up with here are reasonably robust to changes in the load, so you will only need to re-tune these valuses if you have a substantially different pneumatic device.</p> <hr> <div class="section-nav"> <a href="/latest/ros-driver/setup" id="prev-section" class="btn btn-outline"> <i class="fas fa-chevron-left"></i> <div class="section-nav-content"> <div class=section-nav-crumb> ROS Driver / </div> Hardware Setup </div> </a> <a href="/latest/ros-driver/tutorial" id="next-section" class="btn btn-outline"> <div class="section-nav-content"> <div class=section-nav-crumb> ROS Driver / </div> Basic Tutorial </div> <i class="fas fa-chevron-right"></i> </a> </div> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">&copy; 2019-2021 by <a target="_blank" href="http://cbteeple.com">Clark Teeple</a></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> <!--Build the modal overlay for nice picture display--> <div class="wrapper" style="position: relative"> <div id="modal-overlay"> <!-- <a href="javascript:void(0);" id="modal-prev" class="modal-main-nav modal-btn" title="Previous (Left Arrow Key)"> <i class="fas fa-chevron-circle-left"></i> </a> --> <div id="modal" title="Click anywhere to close (Esc)"> <div id="modal-content"> <a href="#" id="modal-img-a" class="img-overlay-container" title="Scroll to Image"> <img id="modal-img"/> </a> <div id="modal-description"/></div> </div> </div> <a href="javascript:void(0);" id="modal-close" class="modal-btn" title="Close (Esc)"> <i class="fas fa-times-circle"></i> </a> <div class="modal-small-nav-container"> <a href="javascript:void(0);" id="modal-prev-aux" class="modal-small-nav modal-btn" title="Previous (Left Arrow Key)"> <i class="fas fa-chevron-circle-left"></i> </a> <a href="javascript:void(0);" id="modal-next-aux" class="modal-small-nav modal-btn" title="Next (Right Arrow Key)"> <i class="fas fa-chevron-circle-right"></i> </a> </div> </div> </div> <script src="/latest/assets/js/img-modal.js"></script> <script src="/latest/assets/js/ext-links.js"></script> <script src="/latest/assets/js/switch-version.js"></script> </body> </html>
